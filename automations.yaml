##   /config/automations.yaml
#############################################################
#                                                           #
#  THE MAJORITY OF MY AUTOMATIONS ARE FOR TRIGGERS AND THE  #
#  ACTIONS HAVE MOSTLY BEEN MOVED TO SCRIPTS WHERE FEASIBLE #
#                                                           #
#############################################################
##                                                         ##
##              MISCELLANEOUS   AUTOMATIONS                ##
##                                                         ##
#############################################################
## make Sonoffs report on start up & alarm state to disarmed
- alias: "Sonoff report state on start-up"
  hide_entity: true
  initial_state: 'on'
  trigger:
    platform: homeassistant
    event: start
  action:
    - service: mqtt.publish
      data:
        topic: "cmnd/sonoffs/backlog"
        payload: "status 2;power1 ;power2 ;power3 ;power4 ;power5 "
#### 'rpi_power_issue'
- alias: "Power Problem Notify"
  trigger:
  - platform: numeric_state
    entity_id: sensor.rpi_power_status
    above: 0
    for:
      minutes: 1
  condition:
  action:
    service: persistent_notification.create
    data:
      message: "Charger reported {{ states.sensor.rpi_power_status.state }}"
      title: "Power Supply Issue"

- alias: Life360 Overdue Update
  trigger:
    platform: event
    event_type: life360_update_overdue
  action:
    service: notify.notify_all
    data_template:
      title: Life360 update overdue
      message: >
        Update for {{
          state_attr(trigger.event.data.entity_id, 'friendly_name') or
          trigger.event.data.entity_id
        }} is overdue.

- alias: Life360 Update Restored
  trigger:
    platform: event
    event_type: life360_update_restored
  action:
    service: notify.notify_all
    data_template:
      title: Life360 update restored
      message: >
        Update for {{
          state_attr(trigger.event.data.entity_id, 'friendly_name') or
          trigger.event.data.entity_id
        }} restored after {{ trigger.event.data.wait }}.
###########################################################
##  Darren's alarm
- alias: 'Darrens wake up alarm'
  hide_entity: true
  initial_state: 'on'
  trigger:
    platform: template
    value_template: "{{ states('sensor.time') == (states.input_datetime.time_darrens_alarm.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  action:
    - service: script.darrens_wake_up
###########################################################
##  Donna's alarm
- alias: 'Donnas wake up alarm'
  hide_entity: true
  initial_state: 'on'
  trigger:
    platform: template
    value_template: "{{ states('sensor.time') == (states.input_datetime.time_donnas_alarm.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  condition:
    - condition: state
      entity_id: input_boolean.donnas_work_alarm
      state: 'on'
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
  action:
    - service: script.donnas_wake_up
######################################################
- alias: '[Notify] Smoke Detected'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.garage_smoke_detected
        - binary_sensor.laundry_smoke_detected
        - binary_sensor.office_smoke_detected
        - binary_sensor.guest_smoke_detected
        - binary_sensor.bedroom_smoke_detected
      to: 'on'
  action:
    - service: script.smoke_popup
    - service: homeassistant.turn_off
      entity_id:
        - switch.dryer_plug
###########################################################
- alias: '[Notify] Water Heater Leak'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.water_heater
      to: 'on'
  action:
    - service: script.water_heater_leak
###########################################################
- alias: '[Notify] Washing Machine Leak'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.washer_leak
      to: 'on'
  action:
    - service: homeassistant.turn_off
      entity_id:
        - switch.washer_plug
    - service: script.washer_leak
#########################################################
- alias: '[Notify] mailbox'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.wyzesense_7782a115
      to: 'on'
  condition:
    - condition: state
      entity_id: input_boolean.disable_mail_notifications
      state: 'off'
  action:
    - service: script.mailbox_opened
#########################################################
- alias: '[Notify] Garage Fridge OFF'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: switch.garage_fridge_relay
      to: 'off'
  action:
    - service: notify.html5_pixel_2_xl
      data_template:
        message: >
          Garage fridge turned off at '{{ now().strftime('%I:%M %p') }}'
    - delay: '00:15:00'
    - service: homeassistant.turn_on
      entity_id: switch.garage_fridge_relay
    - service: notify.html5_pixel_2_xl
      data_template:
        message: >
          Garage fridge turned back on at '{{ now().strftime('%I:%M %p') }}'
###########################################################
#                  TEMPLATE SENSOR UPDATE                 #
- alias: 'Update Template Sensors'
  initial_state: true
  trigger:
      platform: time_pattern
      minutes: '/59'
  action:
    - service: homeassistant.update_entity
      entity_id:
        - sensor.tracker_count
        - sensor.lights_count
        - sensor.binary_sensor_count
        - sensor.switch_count
        - sensor.automation_count
        - sensor.script_count
        - sensor.sensor_count
        - sensor.alert_count
#############################################################
##                                                         ##
##           SCREENS, TABLET & POPUP AUTOMATIONS           ##
##                                                         ##
#############################################################
##  Sets morning background image
- alias: '[Tablet] Morning Background'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: sun.sun
      from: 'below_horizon'
      to: 'above_horizon'
  action:
    - service: script.morning_screen
##  Sets evening Sunset background image
- alias: '[Tablet] Evening Background'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: sun.sun
      from: 'above_horizon'
      to: 'below_horizon'
  action:
    - service: script.star_screen
######################################################
- alias: '[Tablet] camera background select'
  hide_entity: true
  initial_state: 'on'
  trigger:
    platform: time_pattern
    seconds: '/45'
  condition:
    - condition: state
      entity_id: input_boolean.auto_cameras
      state: 'on'
  action:
    - service: input_select.select_next
      entity_id: input_select.auto_camera
######################################################
- alias: '[Tablet] camera image select'
  hide_entity: true
  initial_state: 'on'
  trigger:
    platform: time_pattern
    minutes: '/1'
  condition:
    - condition: state
      entity_id: input_boolean.auto_camera_image
      state: 'on'
  action:
    - service: input_select.select_next
      entity_id: input_select.auto_select_camera
######################################################
- alias: '[Tablet] background select'
  hide_entity: true
  initial_state: 'on'
  trigger:
    platform: time_pattern
    minutes: '/9'
  condition:
    - condition: state
      entity_id: input_boolean.auto_backgroundz
      state: 'on'
  action:
    - service: input_select.select_next
      entity_id: input_select.wallpaper
######################################################
- alias: '[Mobile] background select'
  hide_entity: true
  initial_state: 'on'
  trigger:
    platform: time_pattern
    minutes: '/3'
  action:
    - service: input_select.select_next
      entity_id:
        - input_select.mobile_wallpaper
        - input_select.donnas_wallpaper
        - input_select.rambo_pics
######################################################
- alias: '[Tablet] motion_ON'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.hall_motion, binary_sensor.hallway_motion
      to: 'on'
  condition:
    - condition: state
      entity_id: light.hallway_night_light
      state: 'off'
    - condition: time
      after: '05:30:00'
      before: '23:00:00'
    - condition: state
      entity_id: input_boolean.auto_tablet
      state: 'on'
  action:
    - service: script.wake_tablet
######################################################
- alias: '[Tablet] motion_OFF_night'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: light.hallway_night_light
      to: 'off'
      for:
        minutes: 6
  condition:
    - condition: time
      after: '21:30:01'
      before: '09:30:00'
    - condition: state
      entity_id: input_boolean.auto_tablet
      state: 'on'
  action:
    - service: browser_mod.blackout # script.off_screen ## BLACK SCREEN/ALERT BORDERS
######################################################
- alias: '[Tablet] motion_OFF_day'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: light.hallway_night_light
      to: 'off'
      for:
        minutes: 6
  condition:
    - condition: time
      after: '05:30:01'
      before: '21:30:00'
    - condition: state
      entity_id: input_boolean.auto_tablet
      state: 'on'
  action:
    - service: script.sleep_tablet ## CLOCK SCREENSAVER
######################################################
- alias: '[Browser] switch_browser_home'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: input_boolean.browser_home
      to: 'on'
  action:
    - service: script.browser_home
######################################################
- alias: '[Browser] switch_donnas_screen'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: input_boolean.donnas_screen
      to: 'on'
  action:
    - service: script.browser_donna
######################################################
- alias: '[Browser] switch_browser_refresh'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: input_boolean.browser_refresh
      to: 'on'
  action:
    - service: script.browser_refresh
#########################################################
- alias: '[Browser] Reload Lovelace'
  hide_entity: true
  initial_state: 'on'
  trigger:
    platform: time_pattern
    minutes: '/30'
  action:
    - service: script.browser_tablet
- alias: '[Browser] lovelace lock ON'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: input_boolean.lovelace_lock
      to: 'off'
  action:
    - service: script.mobile_lovelace_lock

- alias: '[Browser] lovelace lock OFF'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: input_boolean.lovelace_lock
      to: 'on'
  action:
    - service: browser_mod.close_popup
######################################################
#########################################################
- alias: '[Browser] popup_front_door'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.wyzesense_77878ecb
      from: 'off'
      to: 'on'
  condition:
    - condition: state
      entity_id: script.browser_popup_1
      state: 'off'
  action:
#    - service: script.front_motion_tv          # for camera stream via chromecast
    - service: script.browser_popup_1
    - service: script.front_notify
    - delay: '00:02:00'
    - service: media_player.volume_set
      data:
        entity_id: media_player.foyer_speaker
        volume_level: '0.40'
#    - service: media_player.stop               # for camera stream via chromecast
#      entity_id: media_player.living_room_tv   # for camera stream via chromecast
#########################################################
- alias: '[Browser] popup_patio'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.back_motion
      to: 'on'
  condition:
    - condition: state
      entity_id: script.browser_popup_6
      state: 'off'
    - condition: state
      entity_id: input_boolean.disable_patio_motion
      state: 'off'
  action:
    - service: script.browser_popup_6
    - service: script.patio_motion
    - service: script.patio_light
    - delay: '00:02:10'
    - service: media_player.volume_set
      data:
        entity_id: media_player.living_room_google
        volume_level: '0.40'
#########################################################
- alias: '[Browser] popup_driveway'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.driveway_motion
      to: 'on'
  condition:
    - condition: state
      entity_id: script.browser_popup_7
      state: 'off'
  action:
    - service: script.browser_popup_7
    - service: script.driveway_notify
    - service: script.driveway_light
    - delay: '00:02:00'
    - service: media_player.volume_set
      data:
        entity_id: media_player.living_room_google
        volume_level: '0.40'
#########################################################
- alias: '[Browser] popup_garage'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.wyzesense_7780f0c5, binary_sensor.wyzesense_77879025, binary_sensor.wyzesense_77879826, binary_sensor.garage_motion
      to: 'on'
  condition:
    - condition: state
      entity_id: script.browser_popup_3
      state: 'off'
  action:
#    - service: script.garage_motion_tv         # for camera stream via chromecast
    - service: script.browser_popup_3
    - service: script.garage_notify # google TTS
    - delay: '00:02:00'
    - service: media_player.volume_set
      data:
        entity_id: media_player.living_room_google
        volume_level: '0.40'
#    - service: media_player.stop               # for camera stream via chromecast
#      entity_id: media_player.living_room_tv   # for camera stream via chromecast
#########################################################
- alias: '[Browser] popup_entry_hall'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.wyzesense_778797dc, binary_sensor.side_door_k, binary_sensor.garage_entry_door_k
      from: 'off'
      to: 'on'
  condition:
    - condition: state
      entity_id: input_boolean.disable_inside_popups
      state: 'off'
  action:
    - service: script.browser_popup_2
#########################################################
- alias: '[Browser] popup_den'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.hall_motion, binary_sensor.wyzesense_7780F0B4
      to: 'on'
  condition:
    - condition: state
      entity_id: input_boolean.disable_inside_popups
      state: 'off'
  action:
    - service: script.browser_popup_4
#########################################################
- alias: '[Browser] popup_kitchen'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.kitchen_motion
      to: 'on'
  condition:
    - condition: state
      entity_id: input_boolean.disable_inside_popups
      state: 'off'
  action:
    - service: script.browser_popup_5
#########################################################
- alias: '[Browser] test_popup_office'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.office_motion
      to: 'on'
  condition:
    - condition: state
      entity_id: input_boolean.disable_inside_popups
      state: 'off'
  action:
    - service: script.browser_popup_8
#########################################################
- alias: '[Browser] popup_Low Battery'
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id:
        - sensor.pixel2statusbatt
        - sensor.donna_iphone_battery_level
        - sensor.garage_smoke_battery
        - sensor.laundry_room_battery
        - sensor.laundry_smoke_battery
        - sensor.office_smoke_battery
        - sensor.outside_ht_battery
        - sensor.spare_room_battery
        - sensor.porch_ht_battery
        - sensor.guest_smoke_battery
        - sensor.bedroom_smoke_battery
        - sensor.shelly_shht_1_22c698_battery_attr
        - sensor.shelly_shht_1_5a8b2e_battery_attr
        - sensor.frontdoorbatt
        - sensor.garagedoorbatt
        - sensor.laundrymotionbatt
        - sensor.entryhallmotionbatt
        - sensor.hallbathmotionbatt
        - sensor.porchmotionbatt
        - sensor.garagemotion1batt
        - sensor.garagemotion2batt
        - sensor.mailboxsensorbatt
      below: 20
  action:
    - service: script.low_battery_popup
    - service: script.mobile_low_battery
#########################################################
- alias: '[Auto] card background select'
  hide_entity: true
  initial_state: 'on'
  trigger:
    platform: time_pattern
    seconds: '/08'
  condition:
    - condition: state
      entity_id: input_boolean.auto_card_backz
      state: 'on'
  action:
    - service: input_select.select_next
      entity_id: input_select.auto_cardz
#############################################################
##                                                         ##
##                 PRESENCE  AUTOMATIONS                   ##
##                                                         ##
#############################################################
## Turn on fans when hot
- alias: "Turn on Fans"
  trigger:
    platform: numeric_state
    entity_id: sensor.realistic_temperature
    above: '78'
  condition:
    - condition: state
      entity_id: input_boolean.disable_auto_fans
      state: 'off'
  action:
    service: homeassistant.turn_on
    entity_id: group.inside_fans
#############################################################
## Turn off fans when cool & no one home
- alias: "Turn off Fans"
  trigger:
    platform: numeric_state
    entity_id: sensor.realistic_temperature
    below: '78'
  condition:
    - condition: state
      entity_id: group.person_group
      state: 'not_home'
  action:
    service: homeassistant.turn_off
    entity_id: group.inside_fans
#########################################################
## Darren AWAY
- alias: '[Presence] Darren Away'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: group.darren_presence
      to: 'not_home'
  action:
    - service: script.darren_away
#########################################################
## Darren HOME
- alias: '[Presence] Darren Home'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: person.darren
      to: 'home'
  action:
    - service: script.arrived_home_popup
    - service: script.darren_home
###########################################################
## Donna AWAY
- alias: '[Presence] Donna Away'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: group.donna_presence
      to: 'not_home'
  condition:
    - condition: state
      entity_id: input_boolean.donna_home
      state: 'on'
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.donna_home
#    - service: notify.html5_pixel_2_xl
#      data_template:
#        message: >
#          Donna changed from {{ trigger.from_state.state }}
#          to {{ trigger.to_state.state }}
###########################################################
## Donna HOME
- alias: '[Presence] Donna Home'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: person.donna
      to: 'home'
  condition:
    - condition: state
      entity_id: input_boolean.donna_home
      state: 'off'
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.donna_home
#    - service: script.arrived_home_popup
#    - service: notify.html5_pixel_2_xl
#      data_template:
#        message: >
#          Donna changed from {{ trigger.from_state.state }}
#          to {{ trigger.to_state.state }}
###########################################################
## Tristan AWAY/HOME
- alias: '[Presence] Tristan Away'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: group.tristan_presence
      to: 'not_home'
      for:
        minutes: 07
  condition:
    - condition: state
      entity_id: input_boolean.tristan_home
      state: 'on'
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.tristan_home
    - service: notify.darren
      data:
        title: "New Life Alert"
        message: "Tristan has left."
###########################################################
- alias: '[Presence] Tristan Home'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: group.tristan_presence
      to: 'home'
  condition:
    - condition: state
      entity_id: input_boolean.tristan_home
      state: 'off'
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.tristan_home
    - service: notify.darren
      data:
        title: "New Life Alert"
        message: "Tristan is at the house."
###########################################################
- alias: '[Presence] People Away Group'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: group.person_group
      to: 'not_home'
  action:
    - service: script.alarm_arm
    - service: script.people_away
    - service: script.off_screen
    - service: script.nest_set_away
###########################################################
- alias: '[Presence] People Home Group'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: group.person_group
      to: 'home'
  action:
    - service: script.alarm_disarm
    - service: script.people_home
    - service: script.wake_tablet
    - service: script.nest_set_home
###############################################################
##                                                           ##
##            Door Auto Lights/Notification/Timers           ##
##                                                           ##
###############################################################
# Bedroom Lamp switch OFF-ON for 2 nightstand lamps
- alias: '[Switch] Bedroom Lamps'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: input_boolean.bedroom_lamps
  action:
    - service_template: "homeassistant.turn_{{- trigger.to_state.state -}}"
      data:
        entity_id: group.bedroom_lamps
###########################################################
##  needed if coffee is started by GH via voice routine
##  or manually turned on
- alias: '[Notify] Coffee Maker ON'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: switch.coffee_maker
      to: 'on'
  action:
    - service: switch.turn_on
      entity_id: switch.coffee_light
    - service: notify.darren
      data:
        title: "New Life Alert"
        message: "Coffee Maker is ON!"
###########################################################
- alias: '[TIMER] Fountain'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: time
      at: '20:00'
  action:
    - service: script.fountain_timer
    - service: homeassistant.turn_on
      entity_id: light.patio_accent_lights
###########################################################
##  Side Door Light on After Sunset
- alias: '[SUNSET] Side Light ON'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: sun
      event: 'sunset'
      offset: "00:30:00"
  action:
    - service: script.side_light_timer
###########################################################
##  Turn On Cabinet Lights at 5:35
- alias: '[TIMER] Turn On Cabinet Lights at 5:35'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: time
      at: '05:35'
  condition:
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
    - condition: state
      entity_id: input_boolean.disable_cabinet_auto_lights
      state: 'off'
  action:
    - service: switch.turn_on
      entity_id: light.cabinet_lights
######################################################
- alias: '[Auto On] Bedroom Auto Lamps'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.bedroom_motion
      to: 'on'
  condition:
    - condition: state
      entity_id: input_boolean.disable_auto_bedroom
      state: 'off'
    - condition: time
      after: '15:30:00'
      before: '21:30:00'
  action:
    - service: homeassistant.turn_on
      entity_id: group.bedroom_lamps
###########################################################
##  Cabinet Auto Lights Switch
- alias: '[Switch] Cabinet Lights'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: light.cabinet_lights
  action:
    - service_template: "homeassistant.turn_{{- trigger.to_state.state -}}"
      data:
        entity_id: group.cabinet_lights
###########################################################
##  Cabinet Motion Auto Lights
- alias: '[Auto] Cabinet Light ON'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.wyzesense_7787900d, binary_sensor.wyzesense_77878a66
      to: 'on'
  action:
    - service: homeassistant.turn_on
      entity_id: group.cabinet_lights

- alias: '[Auto] Cabinet Light OFF 1'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.wyzesense_7787900d
      from: 'on'
      to: 'off'
      for:
        minutes: 5
  condition:
    - condition: state
      entity_id: input_boolean.disable_cabinet_auto_lights
      state: 'off'
    - condition: state
      entity_id: binary_sensor.wyzesense_77878a66
      state: 'off'
  action:
    - service: homeassistant.turn_off
      entity_id: group.cabinet_lights

- alias: '[Auto] Cabinet Light OFF 2'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.wyzesense_77878a66
      from: 'on'
      to: 'off'
      for:
        minutes: 5
  condition:
    - condition: state
      entity_id: input_boolean.disable_cabinet_auto_lights
      state: 'off'
    - condition: state
      entity_id: binary_sensor.wyzesense_7787900d
      state: 'off'
  action:
    - service: homeassistant.turn_off
      entity_id: group.cabinet_lights
###########################################################
##  Entry Hall Auto Light
- alias: '[Auto] Entry Hall Light'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.wyzesense_778797dc
  action:
    - service_template: "homeassistant.turn_{{- trigger.to_state.state -}}"
      data:
        entity_id: light.entry_hall_lights
###########################################################
##  Laundry Auto Light
- alias: '[Auto] Laundry Light'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.wyzesense_778168e9
  action:
    - service_template: "homeassistant.turn_{{- trigger.to_state.state -}}"
      data:
        entity_id: light.laundry_light
###########################################################
##  Porch Auto Light
- alias: '[Auto] Porch Light'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.wyzesense_77878ecb
  condition:
    - condition: state
      entity_id: sun.sun
      state: below_horizon
    - condition: state
      entity_id: input_boolean.disable_exterior_auto_lights
      state: 'off'
  action:
    - service_template: "homeassistant.turn_{{- trigger.to_state.state -}}"
      data:
        entity_id: light.porch_light
###########################################################
##  Hall Bath Automations Lights and vent
- alias: '[Auto] Hall Bath Night Light'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.wyzesense_77802215
  condition:
    - condition: time
      after: '22:30:00'
      before: '06:00:00'
    - condition: state
      entity_id: input_boolean.disable_auto_bathroom
      state: 'off'
  action:
    - service_template: "homeassistant.turn_{{- trigger.to_state.state -}}"
      data:
        entity_id: light.bathroom_ceiling

- alias: '[Auto] Hall Bath Light'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.wyzesense_77802215
  condition:
    - condition: state
      entity_id: sun.sun
      state: below_horizon
    - condition: time
      before: '22:29:59'
      after: '06:00:01'
    - condition: state
      entity_id: input_boolean.disable_auto_bathroom
      state: 'off'
  action:
    - service_template: "homeassistant.turn_{{- trigger.to_state.state -}}"
      data:
        entity_id: light.bathroom_mirror

## Turn off vent after 5 mins
- alias: '[Auto] Hall Bath Vent auto off'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: switch.bathroom_vent
      from: 'off'
      to: 'on'
      for:
        minutes: 5
  action:
    - service: homeassistant.turn_off
      entity_id: switch.bathroom_vent

## Turn on vent when humid
- alias: "Turn on vent"
  hide_entity: true
  initial_state: 'on'
  trigger:
    platform: numeric_state
    entity_id: sensor.bathroom_humidity
    above: '75'
  action:
    service: homeassistant.turn_on
    entity_id: switch.bathroom_vent

## Turn off vent when humidity lowers
- alias: "Turn off vent"
  hide_entity: true
  initial_state: 'on'
  trigger:
    platform: numeric_state
    entity_id: sensor.bathroom_humidity
    below: '74'
  action:
    service: homeassistant.turn_off
    entity_id: switch.bathroom_vent
###########################################################
#  [Notify] Motion Office Light ON/OFF
- alias: '[Notify] Motion Office'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.office_motion
      from: 'off'
      to: 'on'
  condition:
    - condition: state
      entity_id: input_boolean.darren_home
      state: 'off'
  action:
    - service: script.motion_office
#####################################################
- alias: '[Notify/Light] Back Door'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.back_door_k
      to: 'on'
  action:
    - service: script.back_door_light
    - service: script.back_door_notify
    - delay: '00:02:00'
    - service: media_player.volume_set
      data:
        entity_id: media_player.living_room_google
        volume_level: '0.40'
######################################################
- alias: '[Notify] Side door'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.side_door_k
      to: 'on'
  action:
    - service: script.side_door_voice
    - service: script.side_door_open
    - delay: '00:02:00'
    - service: media_player.volume_set
      data:
        entity_id: media_player.living_room_google
        volume_level: '0.40'
######################################################
- alias: '[Notify/Light] Front door'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.wyzesense_7780F0B4
      to: 'on'
  action:
    - service: script.front_door_notify
    - delay: '00:02:00'
    - service: media_player.volume_set
      data:
        entity_id: media_player.foyer_speaker
        volume_level: '0.40'
######################################################
- alias: '[Notify/Light] Garage Entry door'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.garage_entry_door_k
      to: 'on'
  action:
    - service: script.garage_entry_light
    - service: script.garage_entry_voice
    - service: script.garage_entry_door_open
    - delay: '00:02:00'
    - service: media_player.volume_set
      data:
        entity_id: media_player.living_room_google
        volume_level: '0.40'
###########################################################
##  Garage Auto Lights
- alias: '[Auto] Garage Light ON'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.wyzesense_77879826, binary_sensor.wyzesense_77879025
      to: 'on'
  action:
    - service: homeassistant.turn_on
      entity_id: light.garage_ceiling_lights

- alias: '[Auto] Garage Light OFF 1'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.wyzesense_77879826
      from: 'on'
      to: 'off'
  condition:
    - condition: state
      entity_id: binary_sensor.wyzesense_77879025
      state: 'off'
    - condition: state
      entity_id: input_boolean.disable_garage_auto_lights
      state: 'off'
  action:
    - service: homeassistant.turn_off
      entity_id: light.garage_ceiling_lights
    - service: script.browser_close_popup

- alias: '[Auto] Garage Light OFF 2'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.wyzesense_77879025
      from: 'on'
      to: 'off'
  condition:
    - condition: state
      entity_id: binary_sensor.wyzesense_77879826
      state: 'off'
    - condition: state
      entity_id: input_boolean.disable_garage_auto_lights
      state: 'off'
  action:
    - service: homeassistant.turn_off
      entity_id: light.garage_ceiling_lights
    - service: script.browser_close_popup
#####################################################
- alias: '[Notify] Auto Notifications ON'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: time
      at: '23:00:00'
  action:
    - service: script.notifications_auto_on
#############################################################
##                                                         ##
##             Washer  &   Dryer  Automations              ##
##                                                         ##
#############################################################
- alias: 'Washer State - Start'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: numeric_state
      entity_id: sensor.washer_watts
      above: 5
      for:
        seconds: 4
  condition:
    - condition: template
      value_template: "{{ states.sensor.washer_state.state != 'Washing' }}"
  action:
    - service: mqtt.publish
      data:
        topic: hass/state/washer
        payload: 'Washing'
        retain: 'true'
- alias: 'Washer State - Idle'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: numeric_state
      entity_id: sensor.washer_watts
      below: 5
      for:
        minutes: 5
  action:
    - service: mqtt.publish
      data:
        topic: hass/state/washer
        payload: 'Idle'
        retain: 'true'
- alias: 'Washer Finished'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: sensor.washer_state
      from: 'Washing'
      to: 'Idle'
  condition:
    - condition: state
      entity_id: input_boolean.disable_laundry_notifications
      state: 'off'
  action:
    - service: media_player.volume_set
      data:
        entity_id: media_player.living_room_google
        volume_level: '0.50'
    - service: tts.google_say
      entity_id: media_player.living_room_google
      data_template:
        message: "Donna or Darren.. Clothes ready..  The washing machine has finished!"
#- alias: 'Dryer State - Door'
#  trigger:
#    platform: numeric_state
#    entity_id: sensor.dryer_watts
#    above: 7
#    below: 20
#    for:
#      seconds: 2
#  action:
#    - service: mqtt.publish
#      data:
#        topic: hass/state/dryer
#        payload: 'Door Open'
#        retain: 'true'
- alias: 'Dryer State - Drying'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: numeric_state
      entity_id: sensor.dryer_watts
      above: 50
      for:
        seconds: 2
  action:
    - service: mqtt.publish
      data:
        topic: hass/state/dryer
        payload: 'Drying'
        retain: 'true'
- alias: 'Dryer State - Idle'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: numeric_state
      entity_id: sensor.dryer_watts
      below: 6
      for:
        seconds: 2
  action:
    - service: mqtt.publish
      data:
        topic: hass/state/dryer
        payload: 'Idle'
        retain: 'true'
- alias: 'Dryer Finished'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: sensor.dryer_state
      from: 'Drying'
      to: 'Idle'
  condition:
    - condition: state
      entity_id: input_boolean.disable_laundry_notifications
      state: 'off'
  action:
    - service: media_player.volume_set
      data:
        entity_id: media_player.living_room_google
        volume_level: '0.50'
    - service: tts.google_say
      entity_id: media_player.living_room_google
      data_template:
        message: "Donna or Darren.. Clothes ready..  The dryer has finished!"
#############################################################
##                                                         ##
##                   ALARM   AUTOMATIONS                   ##
##                                                         ##
#############################################################
- alias: '[Alarm] Trigger Alarm Home Mode'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: group.all_windows
      to: 'on'
    - platform: state
      entity_id:
        - binary_sensor.side_door_k
        - binary_sensor.back_door_k
        - binary_sensor.wyzesense_7780F0B4
      to: 'on'
  condition:
    - condition: state
      entity_id: alarm_control_panel.ha_alarm
      state: armed_home
  action:
    - service: script.home_mode_trigger
######################################################
- alias: '[Alarm] Trigger Alarm Away Mode'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: group.all_windows
      to: 'on'
    - platform: state
      entity_id:
        - binary_sensor.living_room_motion
        - binary_sensor.bedroom_motion
        - binary_sensor.office_motion
      to: 'on'
    - platform: state
      entity_id:
        - binary_sensor.side_door_k
        - binary_sensor.back_door_k
        - binary_sensor.wyzesense_7780F0B4
        - binary_sensor.garage_entry_door_k
      to: 'on'
  condition:
    - condition: state
      entity_id: alarm_control_panel.ha_alarm
      state: armed_away
  action:
    - service: script.away_mode_trigger
######################################################
#   alarm light flash on
- alias: '[Alarm] Triggered Flash'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: alarm_control_panel.ha_alarm
      to: triggered
  action:
    - service: script.alarm_panel_popup
    - service: script.triggered_flash
######################################################
#   alarm disarm
- alias: '[Alarm] Disarmed Off'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: alarm_control_panel.ha_alarm
      to: disarmed
  action:
    - service: script.alarm_disarm
#####################################################
- alias: '[Alarm] System Arming'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: alarm_control_panel.ha_alarm
      to: pending
  action:
    - service: script.system_arming
#####################################################
- alias: '[Alarm] Away Mode Armed'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: alarm_control_panel.ha_alarm
      to: armed_away
  action:
    - service: script.away_mode_armed
######################################################
- alias: '[Alarm] Home Mode Armed'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: alarm_control_panel.ha_alarm
      to: armed_home
  action:
    - service: script.home_mode_armed
######################################################
- alias: '[Alarm] Remote Disarm'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: input_boolean.alarm_disarm_switch
      to: 'on'
  action:
    - service: script.alarm_disarm
######################################################
- alias: '[Alarm] Remote Arm Away'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: input_boolean.alarm_arm_away_switch
      to: 'on'
  condition:
    - condition: state
      entity_id: alarm_control_panel.ha_alarm
      state: disarmed
    - condition: state
      entity_id: input_boolean.people_home_boolean
      state: 'off'
  action:
    - service: script.alarm_arm
######################################################
- alias: '[Alarm] Remote Arm Home'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: input_boolean.alarm_arm_home_switch
      to: 'on'
  condition:
    - condition: state
      entity_id: alarm_control_panel.ha_alarm
      state: disarmed
  action:
    - service: script.alarm_arm_home
######################################################
- alias: '[Alarm] Auto Night Arm'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: time
      at: '23:59:00'
  condition:
    - condition: state
      entity_id: alarm_control_panel.ha_alarm
      state: disarmed
  action:
    - service: script.alarm_arm_home
#####################################################
- alias: '[Alarm] Disarm in the morning'
  hide_entity: true
  initial_state: 'on'
  trigger:
    - platform: time
      at: '06:30:00'
  condition:
    - condition: state
      entity_id: group.all_devices
      state: home
  action:
    - service: script.alarm_disarm
#####################################################
- alias: 'Weekly Dropbox backup'
  hide_entity: true
  initial_state: 'on'
  trigger:
    platform: time
    at: '2:00:00'
  condition:
    - condition: time
      weekday:
        - mon
  action:
    - service: hassio.snapshot_full
      data_template:
        name: Automated Backup {{ now().strftime('%Y-%m-%d') }}
    - delay: '01:00:00'
    - service: hassio.addon_stdin
      data_template:
        addon: "7be23ff5_dropbox_sync"
        input: {"command":"upload"}
    - delay: '00:05:00'
    - service: notify.html5_pixel_2_xl
      data:
        message: "Check DropBox Upload"
###########################################################
- alias: 'snapshots_went_stale'
  initial_state: true
  trigger:
  - platform: state
    entity_id: binary_sensor.snapshots_stale
    from: 'False'
    to: 'True'
  action:
  - service: notify.darren
    data:
      title: 'Snapshots are Stale'
      message: 'Please visit the Hass.io Google Drive Backup add-on status page for details.'
  - service: script.stale_snapshot_popup
###########################################################
## IOS AUTOMATIONS
- alias: '[IOS] Camera Motion Front'
  initial_state: true
  trigger:
    platform: state
    entity_id: binary_sensor.wyzesense_77878ecb
    from: 'off'
    to: 'on'
  action:
    service: notify.ios_donnas_iphone
    data:
      title: ALERT
      message: Someone is at the Front Door
      data:
        attachment:
          content-type: jpeg
        push:
          category: camera
        entity_id: camera.front_door
- alias: '[IOS] trigger the alarm'
  initial_state: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: TRIGGER_ALARM
  action:
    service: script.home_mode_trigger
- alias: '[IOS] turn on front lights'
  initial_state: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: FRONT_LIGHTS
  action:
  - service: homeassistant.turn_on
    data:
      entity_id: group.backyard
- alias: '[IOS] turn on backyard lights'
  initial_state: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: BACK_LIGHTS
  action:
  - service: homeassistant.turn_on
    data:
      entity_id: group.backyard
- alias: '[IOS] notification TTS button'
  initial_state: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: TTS_MESSAGE
  action:
  - service: media_player.volume_set
    data:
      entity_id: media_player.foyer_speaker
      volume_level: '0.60'
  - service: tts.google_say
    entity_id: media_player.foyer_speaker
    data_template:
      message: '{{ trigger.event.data["textInput"] }}'
